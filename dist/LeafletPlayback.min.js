!function(t){var e;if("function"==typeof define&&define.amd)define(["leaflet"],t);else if("object"==typeof module&&"object"==typeof module.exports)e=require("leaflet"),module.exports=t(e);else{if(void 0===window.L)throw"Leaflet must be loaded first";t(window.L)}}(function(s){return s.Playback=s.Playback||{},s.Playback.Util=s.Class.extend({statics:{DateStr:function(t){var e=new Date(t),i=e.getDate(),a=e.getMonth()+1;return(i=i<10?"0"+i:i)+"."+(a=a<10?"0"+a:a)+"."+e.getFullYear()},TimeStr:function(t){var e=new Date(t),i=e.getHours(),a=e.getMinutes(),n=e.getSeconds();return i<10&&(i="0"+i),a<10&&(a="0"+a),n<10&&(n="0"+n),i+":"+a+":"+n},ParseGPX:function(t){for(var e={type:"FeatureCollection",features:[]},i=$.parseXML(t),a=$(i).find("trk"),n=0,r=a.length;n<r;n++){var s=a[n],o={type:"Feature",geometry:{type:"MultiPoint",coordinates:[]},properties:{trk:{},time:[],speed:[],altitude:[],bbox:[]}};o.properties.trk.name=$(s).find("name").text(),o.properties.trk.desc=$(s).find("desc").text(),o.properties.trk.type=$(s).find("type").text(),o.properties.trk.src=$(s).find("src").text();for(var l=$(s).find("trkpt"),c=0,h=l.length;c<h;c++){var _=l[c],u=parseFloat(_.getAttribute("lat")),k=parseFloat(_.getAttribute("lon")),p=$(_).find("time").text(),d=$(_).find("ele").text(),m=new Date(p).getTime(),f=parseFloat(d),y=o.geometry.coordinates,b=o.properties.time,T=o.properties.altitude;y.push([k,u]),b.push(m),T.push(f)}e.features.push(o)}return e}}}),s.Playback=s.Playback||{},s.Playback.MoveableMarker=s.Marker.extend({initialize:function(t,e,i){var a=e.marker||{};jQuery.isFunction(a)&&(a=a(i)),a.icon.options.extraDivClasses="track-marker",a.icon.options.trackName=i.name,s.Marker.prototype.initialize.call(this,t,a),this.popupContent="",this.feature=i,a.getPopup&&(this.popupContent=a.getPopup(i)),e.popups&&this.bindPopup(this.getPopupContent()+t.toString()),e.labels&&(this.bindLabel?this.bindLabel(this.getPopupContent()):console.log("Label binding requires leaflet-label (https://github.com/Leaflet/Leaflet.label)"))},getPopupContent:function(){return""!==this.popupContent?"<b>"+this.popupContent+"</b><br/>":""},move:function(t,e){s.DomUtil.TRANSITION&&(this._icon&&(this._icon.style[s.DomUtil.TRANSITION]="all "+e+"ms linear",this._popup&&this._popup._wrapper&&(this._popup._wrapper.style[s.DomUtil.TRANSITION]="all "+e+"ms linear")),this._shadow&&(this._shadow.style[s.DomUtil.TRANSITION]="all "+e+"ms linear")),this.setLatLng(t),this._popup&&this._popup.setContent(this.getPopupContent()+this._latlng.toString())},_old__setPos:s.Marker.prototype._setPos,_updateImg:function(t,e,i){var a="";a+=" translate("+-(e=s.point(i).divideBy(2)._subtract(s.point(e))).x+"px, "+-e.y+"px)",a+=" rotate("+this.options.iconAngle+"deg)",a+=" translate("+e.x+"px, "+e.y+"px)",t.style[s.DomUtil.TRANSFORM]+=a},setIconAngle:function(t){this.options.iconAngle=t,this._map&&this.update()},_setPos:function(t){if(this._icon&&(this._icon.style[s.DomUtil.TRANSFORM]=""),this._shadow&&(this._shadow.style[s.DomUtil.TRANSFORM]=""),this._old__setPos.apply(this,[t]),this.options.iconAngle){var e,i=this.options.icon.options.iconAnchor,a=this.options.icon.options.iconSize;this._icon&&(e=this._icon,this._updateImg(e,i,a)),this._shadow&&(a=this.options.icon.options.shadowSize,e=this._shadow,this._updateImg(e,i,a))}}}),s.Playback=s.Playback||{},s.Playback.Track=s.Class.extend({initialize:function(t,e){var i,a,n,r=(e=e||{}).tickLen||250;this._staleTime=e.staleTime||36e5,this._fadeMarkersWhenStale=e.fadeMarkersWhenStale||!1,this._geoJSON=t,this._tickLen=r,this._ticks=[],this._marker=null,this._orientations=[],this._orientIcon=e.orientIcons,"Feature"===t.type?(a=t.geometry.coordinates,i=t.properties.time):(a=[],i=[],t.features.forEach(function(t){a=a.concat(t.geometry.coordinates),i=i.concat(t.properties.time)}));var s,o,l=a[0],c=a[1],h=i[0],_=h,u=i[1],k=_%r;if(1===i.length)return 0!==k&&(_+=r-k),this._ticks[_]=a[0],this._orientations[_]=0,this._startTime=_,void(this._endTime=_);for(0!==k?(o=(s=r-k)/(u-h),_+=s,this._ticks[_]=this._interpolatePoint(l,c,o)):this._ticks[_]=l,this._orientations[_]=this._directionOfPoint(l,c),n=this._orientations[_],this._startTime=_,_+=r;_<u;)o=(_-h)/(u-h),this._ticks[_]=this._interpolatePoint(l,c,o),this._orientations[_]=this._directionOfPoint(l,c),n=this._orientations[_],_+=r;for(var p=1,d=a.length;p<d;p++)for(l=a[p],c=a[p+1],_=h=i[p],u=i[p+1],0!==(k=_%r)&&u?(o=(s=r-k)/(u-h),_+=s,this._ticks[_]=this._interpolatePoint(l,c,o)):this._ticks[_]=l,c?(this._orientations[_]=this._directionOfPoint(l,c),n=this._orientations[_]):this._orientations[_]=n,_+=r;_<u;)o=(_-h)/(u-h),u-h>e.maxInterpolationTime?this._ticks[_]=l:this._ticks[_]=this._interpolatePoint(l,c,o),c?(this._orientations[_]=this._directionOfPoint(l,c),n=this._orientations[_]):this._orientations[_]=n,_+=r;this._endTime=_-r,this._lastTick=this._ticks[this._endTime]},_interpolatePoint:function(e,i,a){try{var t=[i[0]-e[0],i[1]-e[1]],n=[t[0]*a,t[1]*a];return[e[0]+n[0],e[1]+n[1]]}catch(t){console.log("err: cant interpolate a point"),console.log(["start",e]),console.log(["end",i]),console.log(["ratio",a])}},_directionOfPoint:function(t,e){return this._getBearing(t[1],t[0],e[1],e[0])},_getBearing:function(t,e,i,a){t=this._radians(t),e=this._radians(e),i=this._radians(i);var n=(a=this._radians(a))-e,r=Math.log(Math.tan(i/2+Math.PI/4)/Math.tan(t/2+Math.PI/4));return Math.abs(n)>Math.PI&&(n=0<n?-(2*Math.PI-n):2*Math.PI+n),(this._degrees(Math.atan2(n,r))+360)%360},_radians:function(t){return t*(Math.PI/180)},_degrees:function(t){return t*(180/Math.PI)},getFirstTick:function(){return this._ticks[this._startTime]},getLastTick:function(){return this._ticks[this._endTime]},getStartTime:function(){return this._startTime},getEndTime:function(){return this._endTime},getTickMultiPoint:function(){for(var t=this.getStartTime(),e=this.getEndTime(),i=[],a=[];t<=e;)a.push(t),i.push(this.tick(t)),t+=this._tickLen;return{type:"Feature",geometry:{type:"MultiPoint",coordinates:i},properties:{time:a}}},trackPresentAtTick:function(t){return t>=this._startTime},trackStaleAtTick:function(t){return this._endTime+this._staleTime<=t},tick:function(t){return t>this._endTime&&(t=this._endTime),t<this._startTime&&(t=this._startTime),this._ticks[t]},courseAtTime:function(t){return t>this._endTime&&(t=this._endTime),t<this._startTime&&(t=this._startTime),this._orientations[t]},setMarker:function(t,e){var i=null;if(i=t?this.tick(t):this.getFirstTick()){var a=new s.LatLng(i[1],i[0]);this._marker=new s.Playback.MoveableMarker(a,e,this._geoJSON),e.mouseOverCallback&&this._marker.on("mouseover",e.mouseOverCallback),e.clickCallback&&this._marker.on("click",e.clickCallback),this._fadeMarkersWhenStale&&!this.trackPresentAtTick(t)&&this._marker.setOpacity(0)}return this._marker},moveMarker:function(t,e,i){this._marker&&(this._fadeMarkersWhenStale&&(this.trackPresentAtTick(i)?this._marker.setOpacity(1):this._marker.setOpacity(0),this.trackStaleAtTick(i)&&this._marker.setOpacity(.25)),this._orientIcon&&this._marker.setIconAngle(this.courseAtTime(i)),this._marker.move(t,e))},getMarker:function(){return this._marker}}),s.Playback=s.Playback||{},s.Playback.TrackController=s.Class.extend({initialize:function(t,e,i){this.options=i||{},this._map=t,this._tracks=[],this.setTracks(e)},clearTracks:function(){for(;0<this._tracks.length;){var t=this._tracks.pop().getMarker();t&&this._map.removeLayer(t)}},setTracks:function(t){this.clearTracks(),this.addTracks(t)},addTracks:function(t){if(t)if(t instanceof Array)for(var e=0,i=t.length;e<i;e++)this.addTrack(t[e]);else this.addTrack(t)},addTrack:function(t,e){if(t){var i=t.setMarker(e,this.options);i&&(i.addTo(this._map),this._tracks.push(t))}},tock:function(t,e){for(var i=0,a=this._tracks.length;i<a;i++){var n=this._tracks[i].tick(t),r=new s.LatLng(n[1],n[0]);this._tracks[i].moveMarker(r,e,t)}},getStartTime:function(){var t=0;if(0<this._tracks.length){t=this._tracks[0].getStartTime();for(var e=1,i=this._tracks.length;e<i;e++){var a=this._tracks[e].getStartTime();a<t&&(t=a)}}return t},getEndTime:function(){var t=0;if(0<this._tracks.length){t=this._tracks[0].getEndTime();for(var e=1,i=this._tracks.length;e<i;e++){var a=this._tracks[e].getEndTime();t<a&&(t=a)}}return t},getTracks:function(){return this._tracks}}),s.Playback=s.Playback||{},s.Playback.Clock=s.Class.extend({initialize:function(t,e,i){this._trackController=t,this._callbacksArry=[],e&&this.addCallback(e),s.setOptions(this,i),this._speed=this.options.speed,this._tickLen=this.options.tickLen,this._cursor=t.getStartTime(),this._transitionTime=this._tickLen/this._speed},_tick:function(t){t._cursor>t._trackController.getEndTime()?clearInterval(t._intervalID):(t._trackController.tock(t._cursor,t._transitionTime),t._callbacks(t._cursor),t._cursor+=t._tickLen*t.playControl._speed)},_callbacks:function(t){for(var e=this._callbacksArry,i=0,a=e.length;i<a;i++)e[i](t)},addCallback:function(t){this._callbacksArry.push(t)},start:function(){this._intervalID||(this._intervalID=window.setInterval(this._tick,this._transitionTime,this))},stop:function(){this._intervalID&&(clearInterval(this._intervalID),this._intervalID=null)},getSpeed:function(){return this._speed},isPlaying:function(){return!!this._intervalID},setSpeed:function(t){this._speed=t,this._transitionTime=this._tickLen/t,this._intervalID&&(this.stop(),this.start())},setCursor:function(t){var e=parseInt(t);if(e){var i=e%this._tickLen;0!==i&&(e+=this._tickLen-i),this._cursor=e,this._trackController.tock(this._cursor,0),this._callbacks(this._cursor)}},getTime:function(){return this._cursor},getStartTime:function(){return this._trackController.getStartTime()},getEndTime:function(){return this._trackController.getEndTime()},getTickLen:function(){return this._tickLen}}),s.Playback=s.Playback||{},s.Playback.TracksLayer=s.Class.extend({initialize:function(t,e){var i=e.layer||{};jQuery.isFunction(i)&&(i=i(feature)),i.pointToLayer||(i.pointToLayer=function(t,e){return new s.CircleMarker(e,{radius:5})}),i.style=function(t){return t.properties.color?{color:t.properties.color}:{}},this.layer=new s.GeoJSON(null,i),this.layer.addTo(t);var a={"GPS Треки":this.layer};this.overlayControl=s.control.layers(null,a,{collapsed:!1,position:"bottomleft"}).addTo(t)},clearLayer:function(){for(var t in this.layer._layers)this.layer.removeLayer(this.layer._layers[t])},addLayer:function(t){this.layer.addData(t)}}),s.Playback=s.Playback||{},s.Playback.DateControl=s.Control.extend({options:{position:"bottomleft",dateFormatFn:s.Playback.Util.DateStr,timeFormatFn:s.Playback.Util.TimeStr},initialize:function(t,e){s.setOptions(this,e),this.playback=t},onAdd:function(t){this._container=s.DomUtil.create("div","leaflet-control-layers leaflet-control-layers-expanded");var e=this,i=this.playback,a=i.getTime(),n=s.DomUtil.create("div","datetimeControl",this._container);return this._date=s.DomUtil.create("span","",n),this._time=s.DomUtil.create("span","",n),this._date.innerHTML=this.options.dateFormatFn(a)+" ",this._time.innerHTML=this.options.timeFormatFn(a),i.addCallback(function(t){e._date.innerHTML=e.options.dateFormatFn(t)+" ",e._time.innerHTML=e.options.timeFormatFn(t)}),this._container}}),s.Playback.PlayControl=s.Control.extend({options:{position:"bottomleft"},initialize:function(t){this.playback=t},onAdd:function(t){this._container=s.DomUtil.create("div","leaflet-control-layers leaflet-control-layers-expanded");var i=this,a=this.playback;a.setSpeed(100);var n=s.DomUtil.create("div","playControl",this._container);this._button=s.DomUtil.create("button","",n),this._speed=1,this._button.innerHTML="Старт",this._button.className="btn btn_success",this._speedValues=[1,3,5],this._speedButtons=[],this._speedValues.forEach(function(t){var e=s.DomUtil.create("button","",n);e.innerHTML=t+"x",e.className="btn btn_default",e.dataset.speed=t,s.DomEvent.on(e,"click",r,i),i._speedButtons.push(e)}),this._speedButtons[0].className="btn btn_brand";var e=s.DomEvent.stopPropagation;function r(t){var e=a.playControl,i=t.target;e._speedButtons.forEach(function(t){t.className="btn btn_default"}),i.className="btn btn_brand",e._speed=+i.dataset.speed,a.isPlaying()?(a.stop(),a.start(),e._button.innerHTML="Пауза",e._button.className="btn btn_default"):(e._button.innerHTML="Старт",e._button.className="btn btn_success")}return s.DomEvent.on(this._container,"click mousedown dblclick touchmove touchend",e).on(this._container,"click",s.DomEvent.preventDefault).on(this._button,"click",function(){a.isPlaying()?(a.stop(),i._button.innerHTML="Старт",i._button.className="btn btn_success"):(a.start(),i._button.innerHTML="Пауза",i._button.className="btn btn_default")}),this._container}}),s.Playback.SliderControl=s.Control.extend({options:{position:"bottomleft"},initialize:function(t){this.playback=t},onAdd:function(t){this._container=s.DomUtil.create("div","leaflet-control-layers leaflet-control-layers-expanded");var e=this,i=this.playback;this._slider=s.DomUtil.create("input","slider",this._container),this._slider.type="range",this._slider.min=i.getStartTime(),this._slider.max=i.getEndTime(),this._slider.value=i.getTime();var a=s.DomEvent.stopPropagation;return s.DomEvent.on(this._container,"mousedown dblclick click mousemove mouseup touchmove touchend",a).on(this._slider,"change mousemove",function(t){var e=Number(t.target.value);i.setCursor(e)},this),i.addCallback(function(t){e._slider.value=t}),t.on("playback:add_tracks",function(){e._slider.min=i.getStartTime(),e._slider.max=i.getEndTime(),e._slider.value=i.getTime()}),this._container}}),s.Playback=s.Playback.Clock.extend({statics:{MoveableMarker:s.Playback.MoveableMarker,Track:s.Playback.Track,TrackController:s.Playback.TrackController,Clock:s.Playback.Clock,Util:s.Playback.Util,TracksLayer:s.Playback.TracksLayer,PlayControl:s.Playback.PlayControl,DateControl:s.Playback.DateControl,SliderControl:s.Playback.SliderControl},options:{tickLen:250,speed:1,maxInterpolationTime:3e5,tracksLayer:!0,playControl:!1,dateControl:!1,sliderControl:!1,layer:{},marker:{}},initialize:function(t,e,i,a){s.setOptions(this,a),this._map=t,this._trackController=new s.Playback.TrackController(t,null,this.options),s.Playback.Clock.prototype.initialize.call(this,this._trackController,i,this.options),this.options.tracksLayer&&(this._tracksLayer=new s.Playback.TracksLayer(t,a)),this.setData(e),this.options.playControl&&(this.playControl=new s.Playback.PlayControl(this),this.playControl.addTo(t)),this.options.sliderControl&&(this.sliderControl=new s.Playback.SliderControl(this),this.sliderControl.addTo(t)),this.options.dateControl&&(this.dateControl=new s.Playback.DateControl(this,a),this.dateControl.addTo(t))},clearData:function(){this._trackController.clearTracks(),this._tracksLayer&&this._tracksLayer.clearLayer()},getLatLngByTime:function(t,e){return this._trackController.getTracks()[e].tick(t)},setData:function(t){var e;this.clearData(),this.addData(t,this.getTime()),e=this.getStartTime(),this.sliderControl&&(this.sliderControl._slider.min=e,this.sliderControl._slider.max=this.getEndTime()),this.setCursor(e)},addData:function(t,e){if(t&&t.length){for(var i=0,a=t.length;i<a;i++)this._trackController.addTrack(new s.Playback.Track(t[i],this.options),e);this._map.fire("playback:set:data"),this.options.tracksLayer&&this._tracksLayer.addLayer(t)}},destroy:function(){this.clearData(),this.playControl&&this._map.removeControl(this.playControl),this.sliderControl&&this._map.removeControl(this.sliderControl),this.dateControl&&this._map.removeControl(this.dateControl),this._tracksLayer&&this._tracksLayer.overlayControl&&this._map.removeControl(this._tracksLayer.overlayControl)}}),s.Map.addInitHook(function(){this.options.playback&&(this.playback=new s.Playback(this))}),s.playback=function(t,e,i,a){return new s.Playback(t,e,i,a)},s.Playback});